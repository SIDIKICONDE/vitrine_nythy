rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // --- üßç Photos de profil ---
    match /profile_photos/{fileName} {
      allow read: if true;

      allow write: if request.auth != null
                   && (fileName == request.auth.uid + '.jpg' ||
                       fileName == request.auth.uid + '.png' ||
                       fileName == request.auth.uid + '.svg' ||
                       fileName == request.auth.uid + '.webp')
                   && fileName.matches('^[a-zA-Z0-9_-]+\\.(jpg|png|svg|webp)$')
                   && request.resource.size < 5 * 1024 * 1024
                   && (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'image/svg+xml');

      allow delete: if request.auth != null
                    && (fileName == request.auth.uid + '.jpg' ||
                        fileName == request.auth.uid + '.png' ||
                        fileName == request.auth.uid + '.svg' ||
                        fileName == request.auth.uid + '.webp');
    }

    // --- üåÑ Images de fond ---
    match /background_images/{fileName} {
      allow read: if true;

      // Permet:
      // - {userId}.jpg / {userId}.png / {userId}.webp (image de fond normale)
      // - {userId}_collapsed.jpg / {userId}_collapsed.png / {userId}_collapsed.webp (image de fond en mode r√©duit)
      allow write: if request.auth != null
                   && (fileName == request.auth.uid + '.jpg' ||
                       fileName == request.auth.uid + '.png' ||
                       fileName == request.auth.uid + '.webp' ||
                       fileName == request.auth.uid + '_collapsed.jpg' ||
                       fileName == request.auth.uid + '_collapsed.png' ||
                       fileName == request.auth.uid + '_collapsed.webp')
                   && fileName.matches('^[a-zA-Z0-9_-]+(_collapsed)?\\.(jpg|png|webp)$')
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');

      allow delete: if request.auth != null
                    && (fileName == request.auth.uid + '.jpg' ||
                        fileName == request.auth.uid + '.png' ||
                        fileName == request.auth.uid + '.webp' ||
                        fileName == request.auth.uid + '_collapsed.jpg' ||
                        fileName == request.auth.uid + '_collapsed.png' ||
                        fileName == request.auth.uid + '_collapsed.webp');
    }

    // --- üñºÔ∏è Images des posts ---
    match /posts/{fileName} {
      allow read: if true;

      allow write: if request.auth != null
                   && fileName.matches(request.auth.uid + '_[a-zA-Z0-9_-]+\\.(jpg|png|jpeg|svg|webp)$')
                   && request.resource.size < 5 * 1024 * 1024
                   && (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'image/svg+xml');

      allow delete: if request.auth != null
                    && fileName.matches(request.auth.uid + '_[a-zA-Z0-9_-]+\\.(jpg|png|jpeg|svg|webp)$');
    }

    // --- üé• Vid√©os des posts ---
    match /posts/videos/{fileName} {
      allow read: if true;

      allow write: if request.auth != null
                   && fileName.matches(request.auth.uid + '_[a-zA-Z0-9_-]+\\.(mp4|mov|avi)$')
                   && request.resource.size < 100 * 1024 * 1024
                   && request.resource.contentType.matches('video/.*');

      allow delete: if request.auth != null
                    && fileName.matches(request.auth.uid + '_[a-zA-Z0-9_-]+\\.(mp4|mov|avi)$');
    }

    // --- üí¨ Fichiers de messagerie ---
    // Images dans messages/{conversationId}/{fileName}
    // ‚ú® Pas de limite de taille - WebP compresse automatiquement (60-80% r√©duction)
    match /messages/{conversationId}/{fileName} {
      // Lecture : tous les utilisateurs authentifi√©s (filtrage des participants c√¥t√© backend/app)
      allow read: if request.auth != null;

      // √âcriture : utilisateurs authentifi√©s
      // Uniquement pour les images (WebP compresse d√©j√† les images de 60-80%)
      // Format: {userId}_{timestamp}.jpg/.png/.jpeg/.webp
      allow write: if request.auth != null
                   && conversationId.matches('^[a-zA-Z0-9_-]+$')
                   && fileName.matches('^[a-zA-Z0-9_-]+\\.(jpg|png|jpeg|webp)$')
                   && request.resource.contentType.matches('image/.*');

      // Suppression : utilisateur authentifi√© (v√©rifie qu'il est participant via l'app)
      allow delete: if request.auth != null;
    }

    // --- üìé Documents de messagerie ---
    // Fichiers dans messages/{conversationId}/files/{fileName}
    // ‚ùå Les vid√©os sont INTERDITES
    match /messages/{conversationId}/files/{fileName} {
      // Lecture : tous les utilisateurs authentifi√©s (filtrage des participants c√¥t√© backend/app)
      allow read: if request.auth != null;

      // √âcriture : utilisateurs authentifi√©s
      // Format: {userId}_{timestamp}.{extension}
      // Extensions autoris√©es : documents, archives, audio, images, texte, fichiers chiffr√©s (.enc)
      // Formats audio support√©s : MP3, WAV, OGG (Opus), M4A (AAC), AAC, FLAC
      // üé§ Opus/OGG (.ogg) : Format utilis√© pour les messages vocaux am√©lior√©s (codec Opus dans conteneur OGG)
      // MAX 50MB par fichier (sauf audio : 10MB max)
      allow write: if request.auth != null
                   && conversationId.matches('^[a-zA-Z0-9_-]+$')
                   && fileName.matches('^[a-zA-Z0-9_-]+\\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf|odt|ods|odp|zip|rar|7z|tar|gz|jpg|jpeg|png|gif|bmp|svg|mp3|wav|ogg|m4a|aac|flac|csv|json|xml|enc)$')
                   && (
                        // Audio (y compris Opus/OGG .ogg et fichiers chiffr√©s .enc) : MAX 10MB (messages vocaux)
                        ((fileName.matches('.*\\.(mp3|wav|ogg|m4a|aac|flac|enc)$')) && request.resource.size < 10 * 1024 * 1024) ||
                        // Autres fichiers : MAX 50MB
                        (!fileName.matches('.*\\.(mp3|wav|ogg|m4a|aac|flac|enc)$') && request.resource.size < 50 * 1024 * 1024)
                   )
                   && (
                        // Documents Office
                        request.resource.contentType.matches('application/pdf') ||
                        request.resource.contentType.matches('application/msword') ||
                        request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.*') ||
                        request.resource.contentType.matches('application/vnd.ms-excel') ||
                        request.resource.contentType.matches('application/vnd.ms-powerpoint') ||
                        // Archives
                        request.resource.contentType.matches('application/zip') ||
                        request.resource.contentType.matches('application/x-rar-compressed') ||
                        request.resource.contentType.matches('application/x-7z-compressed') ||
                        request.resource.contentType.matches('application/x-tar') ||
                        request.resource.contentType.matches('application/gzip') ||
                        // Images
                        request.resource.contentType.matches('image/.*') ||
                        // Audio (inclut audio/ogg pour Opus/OGG, audio/mp4 pour M4A, audio/mpeg pour MP3, etc.)
                        request.resource.contentType.matches('audio/.*') ||
                        // Fichiers chiffr√©s (audio chiffr√©, y compris Opus/OGG chiffr√©) : application/octet-stream
                        request.resource.contentType.matches('application/octet-stream') ||
                        // Texte
                        request.resource.contentType.matches('text/.*') ||
                        // Autres
                        request.resource.contentType.matches('application/json') ||
                        request.resource.contentType.matches('application/xml') ||
                        request.resource.contentType.matches('text/csv') ||
                        // ‚úÖ FIX: Accepte aussi null contentType (certains fichiers)
                        request.resource.contentType == null
                      )
                   && !fileName.matches('.*\\.(mp4|mov|avi|mkv|wmv|flv|webm|m4v|3gp|ogv)$'); // ‚ùå Bloquer explicitement les vid√©os (ogv = OGG vid√©o, pas audio)

      // Suppression : utilisateur authentifi√© (v√©rifie qu'il est participant via l'app)
      allow delete: if request.auth != null;
    }

    // --- üë• Photos de groupe ---
    match /group_photos/{fileName} {
      // Lecture : tous les utilisateurs authentifi√©s
      allow read: if request.auth != null;

      // √âcriture : tous les utilisateurs authentifi√©s
      // Format: {groupId}_{timestamp}.webp ou .jpg
      // TODO: V√©rifier que l'utilisateur est membre/admin du groupe via Firestore
      allow write: if request.auth != null
                   && fileName.matches('^[a-zA-Z0-9_-]+\\.(jpg|png|jpeg|webp)$')
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');

      // Suppression : tous les utilisateurs authentifi√©s
      // TODO: Limiter aux admins du groupe
      allow delete: if request.auth != null;
    }

    // --- üè™ Images commer√ßants (logo, galerie, produits) ---
    // Stockage par UID pour v√©rifier simplement la propri√©t√© c√¥t√© r√®gles
    // Chemins utilis√©s par l'app:
    // - merchants/{uid}/logo/{fileName}
    // - merchants/{uid}/gallery/{fileName}
    // - merchants/{uid}/products/{any_depth}/{fileName}
    match /merchants/{uid}/{path=**} {
      // Lecture publique pour tous (pour affichage web/app)
      allow read: if true;
      
      // √âcriture : uniquement par le propri√©taire
      // Accepte : JPG, PNG, JPEG, WebP et SVG
      allow write: if request.auth != null
                   && request.auth.uid == uid
                   && request.resource.size < 10 * 1024 * 1024
                   && (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'image/svg+xml');
      
      // Suppression : uniquement par le propri√©taire
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // --- üé´ Screenshots de support client ---
    match /support_screenshots/{userId}/{ticketId}/{fileName} {
      // Lecture : uniquement par le propri√©taire et les admins
      allow read: if request.auth != null
                  && request.auth.uid == userId;

      // √âcriture : uniquement par le propri√©taire
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && fileName.matches('^[0-9]+\\.jpg$')
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');

      // Suppression : uniquement par le propri√©taire
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // --- üì¢ Images des annonces (Admin uniquement) ---
    match /announcements/{fileName} {
      // Lecture publique pour tous
      allow read: if true;

      // √âcriture : uniquement par les administrateurs
      // Format: {userId}_{timestamp}.jpg ou .webp
      // V√©rifie si l'utilisateur est admin dans Firestore
      allow write: if request.auth != null
                   && (
                       // Option 1: Custom claim admin
                       request.auth.token.admin == true ||
                       // Option 2: Document dans collection admins
                       firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid)) ||
                       // Option 3: Champ role='admin' dans users
                       firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin'
                   )
                   && fileName.matches('^[a-zA-Z0-9_-]+_[0-9]+\\.(jpg|png|jpeg|webp)$')
                   && request.resource.size < 10 * 1024 * 1024
                   && (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'image/svg+xml' ||
                       request.resource.contentType == 'image/webp');

      // Suppression : uniquement par les administrateurs
      allow delete: if request.auth != null
                    && (
                        // Option 1: Custom claim admin
                        request.auth.token.admin == true ||
                        // Option 2: Document dans collection admins
                        firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid)) ||
                        // Option 3: Champ role='admin' dans users
                        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin'
                    );
    }

    // --- üìñ Stories (images et vid√©os) ---
    match /stories/{userId}/{fileName} {
      // Lecture publique pour tous (stories visibles par tous les utilisateurs)
      allow read: if true;

      // √âcriture : uniquement par le propri√©taire dans son propre dossier
      // Formats accept√©s : jpg, jpeg, png, webp (images) et mp4, mov, avi (vid√©os)
      // Limite : 50 MB par fichier (pour permettre vid√©os courtes)
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && fileName.matches('^[a-zA-Z0-9_-]+\\.(jpg|jpeg|png|webp|mp4|mov|avi)$')
                   && request.resource.size < 50 * 1024 * 1024
                   && (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('video/.*'));

      // Suppression : uniquement par le propri√©taire
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // --- üö´ Bloquer tout le reste ---
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
